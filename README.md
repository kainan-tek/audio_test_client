# Audio Test Client

Android 音频录制/播放测试工具，支持三种工作模式。

**版本:** 2.0.0

## 功能特性

| 模式 | 参数 | 说明 |
|-----|------|------|
| 录音 | `-m0` | 从指定音频源录制到 WAV 文件 |
| 播放 | `-m1` | 播放 WAV 音频文件 |
| 双工 | `-m2` | 同时录音和播放（回环测试） |

## 快速开始

```bash
# 编译
mm audio_test_client

# 推送到设备
adb root
adb remount
adb push audio_test_client /data/
adb shell
cd /data
chmod 777 /data/audio_test_client

# 录音示例
./audio_test_client -m0 -s1 -r48000 -c2 -f1 -F1 -z960 -d20

# 播放示例
./audio_test_client -m1 -u1 -C0 -O4 -z960 /data/audio_test.wav

# 双工示例
./audio_test_client -m2 -s1 -r48000 -c2 -f1 -F1 -u1 -C0 -O4 -z960 -d20
```

## 命令行参数

```
audio_test_client -m<mode> [options] [audio_file]
```

### 核心参数

| 参数 | 说明 | 默认值 |
|-----|------|-------|
| `-m<mode>` | 模式: 0=录音, 1=播放, 2=双工 | 必填 |
| `-h` | 显示帮助信息 | - |
| `-z<frames>` | 最小帧数 | 系统自动 |

### 录音参数

| 参数 | 说明 |
|-----|------|
| `-s<source>` | 音频源（见下方枚举） |
| `-r<rate>` | 采样率（8000/16000/48000） |
| `-c<count>` | 通道数（1/2/4/8） |
| `-f<format>` | 格式：1=PCM16, 2=PCM8, 3=PCM32 |
| `-F<flag>` | 输入标志 |
| `-d<seconds>` | 录音时长（0=无限） |

### 播放参数

| 参数 | 说明 |
|-----|------|
| `-u<usage>` | 用途类型（见下方枚举） |
| `-C<type>` | 内容类型 |
| `-O<flag>` | 输出标志 |

### 常用枚举值

**音频源 (`-s`)**

| 值 | 说明 |
|---|------|
| 0 | 默认 |
| 1 | 麦克风 |
| 6 | 语音识别 |
| 7 | 通话 |

**用途类型 (`-u`)**

| 值 | 说明 |
|---|------|
| 1 | 媒体 |
| 2 | 通话 |
| 4 | 闹钟 |
| 5 | 通知 |

**音频格式 (`-f`)**

| 值 | 说明 |
|---|------|
| 1 | PCM 16-bit |
| 3 | PCM 32-bit |

## 注意事项

1. 设备需 root 权限
2. 可选：`adb shell setenforce 0` 关闭 SELinux
3. 完整参数列表运行：`./audio_test_client -h`
4. 录音文件自动保存到 `/data/` 目录
5. 最大录音文件限制：2 GiB
6. 按 `Ctrl+C` 可安全终止程序

## 代码架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        工具类                                    │
├─────────────────────────────────────────────────────────────────┤
│  WAVFile              - WAV 文件读写管理                          │
│  BufferManager        - 缓冲区管理                               │
│  AudioUtils           - 音频工具函数集合                          │
│  CommandLineParser    - 命令行参数解析器                          │
│  AudioOperationFactory- 音频操作工厂类                            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     配置与参数管理                                │
├─────────────────────────────────────────────────────────────────┤
│  struct AudioConfig                                             │
│    - 公共参数: sampleRate, channelCount, format                  │
│    - 录音参数: inputSource, inputFlag, durationSeconds           │
│    - 播放参数: usage, contentType, outputFlag                    │
│                                                                 │
│  class AudioParameterManager                                    │
│    - setOpenSource() / setCloseSource()                         │
│    - setChannelMask() / setCustomParameter()                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     核心类层次结构                                │
├─────────────────────────────────────────────────────────────────┤
│                           AudioConfig                           │
│                              │                                  │
│                              ▼                                  │
│              ┌─────────────────────────────────┐               │
│              │     AudioOperation              │               │
│              │   (抽象基类)                     │                │
│              │  - mConfig                      │               │
│              │  - mParamManager                │               │
│              │  + setupSignalHandler()         │               │
│              │  + execute() = 0                │               │
│              └─────────────────────────────────┘               │
│                        │                                       │
│           ┌────────────┼────────────┐                          │
│           ▼            ▼            ▼                          │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐          │
│   │AudioRecord  │ │AudioPlay    │ │AudioDuplex      │          │
│   │Operation    │ │Operation    │ │Operation        │          │
│   │录音模式      │ │播放模式       │ │双工模式          │          │
│   └─────────────┘ └─────────────┘ └─────────────────┘          │
└────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        文件格式                                  │
├─────────────────────────────────────────────────────────────────┤
│  录音输出: /data/audio_<timestamp>.wav                           │
│  文件格式: RIFF WAVE (PCM)                                       │
│  头部大小: 44 bytes                                              │
│  数据限制: 最大 2 GiB                                             │
└─────────────────────────────────────────────────────────────────┘
```

## 项目文件

```
audio_test_client/
├── audio_test_client.cpp    # 主程序源码
├── Android.mk               # Android Makefile
├── Android.bp               # Android.bp
└── README.md                # 本文档
```
